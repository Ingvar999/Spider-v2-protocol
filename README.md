# Проткол взаимодействия с роботом Spider v2

## Введение
В качестве протокола взаимодействия пользователя и робота выступает собственный текстовый протокол на основе средств, предоставляемых транспортным протоколом TCP модуля беспроводной среды связи Wi-Fi.

Решение использования текстового протокола упрощает написание сторонних пользовательских программ взаимодействия, таким образом, консольное приложение может реализовать весь функционал, предусмотренный протоколом. Также использование коротких символьных обозначений уменьшает размер отправляемой команды, обеспечивает переменную длину команды и простоту её дешифрования.
Каждая команда состоит из четырёх частей:
1. идентификатора, необходимого для привязки последующего ответа (символ в дипазоне 'A' - 'Z');
2. тип;
3. специфичные для типа обозначения и параметры;
4. признак конца – символ новой строки.

По типу команды делятся на три группы:
1. изменение свойств;
2. получение информации о состоянии;
3. выполнение действия.

Вышеперечисленные группы команд будут рассмотрены далее в от-дельности. Для простоты во всех примерах далее используется идентификатор команды равный символу латинского алфавита «А».

## Зарезервированные идентификаторы 
Кроме ответов на запросы с указанными идентификаторами от 'A' до 'Z' могут приходить сообщения с зарезервированными идентификаторами.
Символ идентификатора | Описание 
--|--
0 | Получена команда недопустимого формата: неверная длина или идентификатор
1 | Ошибка во время обновления состояния робота или автоматиского контроля хорактеристик. Может изменять состояние робота.

## Команды изменения свойств
Команда изменения свойств позволяет изменять одно логическое свойство робота. Для изменения нескольких свойств необходимо отправить последовательно нужное количество команд для изменения каждого свойства.

Команды данного типа выполняются синхронно в момент принятия её роботом. После обработки команды приложению-отправителю высылается ответ со статусом выполнения. 

Символьный код типа команды – «s». Уникальная часть команды дан-ного типа состоит из символьного кода изменяемого свойства и от нуля до двух целочисленных параметров. Логика выполнения команды может зависеть от количества переданных параметров.
Символьный код свойства |	Описание |	Параметры |	Допустимые значения параметров |	Пример команды
--|--|--|--|--
i |	Включает или выключает подачу питания для ног робота. |	Логическое булевое значение. |	0 или 1 |	Asi0\n
b |	Включает или выключает автоматическое поддержание заданного положения по гироскопу. |	Логическое булевое значение.	| 0 или 1	| Asb0\n
w |	Включает или выключает автоматическое распределение нагрузки на ноги. |	Логическое булевое значение. |	0 или 1	| Asw0\n
h |	Включает или выключает автоматическое поддержание заданной высоты над опорной поверхностью. |	Логическое булевое значение.	| 0 или 1	| Ash0\n
v	| Включает или выключает автоматический контроль уровня заряда элементов электропитания.	| Логическое булевое значение.	| 0 или 1	| Asc0\n
k |	Включает или выключает автоматическое включение света при низкой освещённости.	| Логическое булевое значение.	| 0 или 1	| Asl0\n
r |	Использование красного освещения.	| Логическое булевое значение.	| 0 или 1	| Asr0\n
l |	Ручное включение или выключение света. Использование этой команды неявно выключает контроль освещённости. |	Логическое булевое значение.	| 0 или 1 |	Asf1\n
s |	Устанавливает скорость движения ног.	| Значение скорости. |	0 или 1	| Ass5\n
d |	Устанавливает минимальную дистанцию для автоматического избегания препятствий во время движения.	| Значение дистанции в сантиметрах.	| От 0 до 150	| Asd30\n
p |	Устанавливает необходимое положение гироскопа для автоматического поддержания.	| 1. Вертикальное отклонение в градусах. 2. Направление отклонения в градусах.	| 1. От 0 до 20 2. От -180 до 180 | Asp5 90\n
x |	Устанавливает фиксированную ногу с указанным номером. |	Порядковый номер ноги. |	От 0 до 6	| Asx5\n
x |	Сбрасывает ранее установленное значение номера фиксированной ноги.	| Без параметров.	| -	| Asx\n
z |	Прерывание выполняемого действия.	| Без параметров. |	-	| Asz\n
y |	Сохранение установленных настроек.	| Без параметров. |	-	| Asy\n
u |	Восстановление сохранённых настроек.	| Без параметров. |	-	| Asu\n

## Команды получения информации о состоянии
Команда получения информации о состоянии позволяет запросить значения одного или нескольких параметров состояния робота одной командой. Количество запрашиваемых параметров за раз ограничивается только общими требованиями к размеру команды.

Команды данного типа выполняются синхронно в момент принятия её роботом. После обработки команды приложению-отправителю высылается ответ с статусом выполнения и значениями запрашиваемых параметров, разделённых символом новой строки, что позволяет удобно отображать информацию в консольном приложении без дополнительной обработки. 

Символьный код типа команды – «i». Уникальная часть команды дан-ного типа состоит из последовательности символьных кодов запрашиваемых параметров состояния. В случае нахождения в последовательности незарегистрированного символьного кода параметра, команда будет выполнена без ошибок, а в ответе на его месте будет возвращена строка «N/A». 
Символьный код параметра |	Описание |	Допустимые значения параметра |	Пример ответа на запрос
--|--|--|--
r	| Удалённость постановки ног от корпуса в миллиметрах. |	От 40 до 120	| AOK\n60\n
h	| Высота нахождения корпуса относительно точки опоры в миллиметрах. |	От 0 до 120 |	AOK\n45\n
v	| Напряжение источника электропитания в милливольтах.	| От 0 до 10000 |	AOK\n 8100\n
w	| Относительная нагрузка на каждую из шести ног. |	От 0 до 1023 |	AOK\n123 45 66 59 99 12\n
c	| Минимальная дистанция для автоматического избегания препятствий во время движения в сантиметрах.	| От 0 до 150	| AOK\n30\n
p |	Положение робота в пространстве по данным гироскопа: 1.Отклонение относительно горизонтальной плоскости в градусах. 2.Направление отклонения в градусах.	| 1. От 0 до 90 2. От -180 до 180	| AOK\n3.25 150.1\n
d |	Расстояние до препятствия перед роботом в сантиметрах. |	От 0 до 150	| AOK\n40\n
s |	Скорость движения ног.	| От 0 до 10	| AOK\n5\n
q	| Заданное положение гироскопа для поддержания: 1.Отклонение относительно горизонтальной плоскости в градусах. 2.Направление отклонения в градусах.	| 1. От 0 до 20 2. От -180 до 180	| AOK\n10 100\n
i |	Состояние (включённое или выключенное) режимов: 1.Автоматическое поддержание заданного положения гироскопа. 2.Автоматическое распределение нагрузки на каждую ногу. 3.Автоматическое поддержание заданной высоты. 4.Автоматический контроль уровня заряда источника электропитания. 5.Автоматическое включение света при низкой освещённости. 6.Использование кросного света. 7.Освещение.	8.Питание на ноги | 0 или 1	| AOK\n01110001\n

## Команды действий
Команда действия позволяет выполнить передвижение робота или любое продолжительное по времени действие. Для выполнения нескольких действий необходимо отправить последовательно нужное количество команд для выполнения каждого действия.

Команды данного типа выполняются асинхронно после принятия её роботом. При получении команда добавляется в очередь, и её выполнение будет начато, как только робот закончит выполнение всех предыдущих команд действий. Во время штатной обработки команды возвращается два ответа со статусами выполнения: во время добавления команды в очередь и после завершения выполнения действия.

Символьный код типа команды – «d». Уникальная часть команды данного типа состоит из символьного кода действия и от нуля до двух целочисленных параметров. Логика выполнения действия может зависеть от количества переданных параметров.
Символьный код действия |	Описание |	Параметры |	Допустимые значения параметров |	Пример команды
--|--|--|--|--
r	| Устанавливает абсолютное значение радиуса постановки ног относительно корпуса. |	Новый радиус постановки ног в миллиметрах. |	От 40 до 120	| Adr60\n
h	| Изменение высоты корпуса относительно опорной поверхности.	| Необходимая высота корпуса относительно текущего положения в миллиметрах. |	От -120 до 120	| Adh-20\n
f	| Поворот робота относительно вертикальной оси.	| Угол поворота в градусах	| От -360 до 360	| Adf30\n
t	| Временный поворот робота относительно вертикальной оси.	| Угол поворота в градусах	| От -20 до 20	| Adt10\n
b	| Принятие роботом базового положения.	| Без параметров	| - |	Adb\n
w	| Прямолинейное движение робота в заданном направлении. Избегание препятствий не активно.	| Направление движения в градусах.	| От -180 до 180	| Adw60\n
w |	Прямолинейное движение робота прямо  (направление ноль градусов). Избегание препятствий активно. |	Без параметров	| -	| Adw100\n
<span>-</span>	| Установка нового радиуса постановки для фиксированной ноги.	| Новый радиус постановки ног в миллиметрах.	| От 40 до 120	| Ad-60\n
вертикальная черта | Изменение высоты постановки фиксированной ноги.	| Необходимая высота ноги относительно текущего положения в миллиметрах. |	От -120 до 120	| Ad!20\n
)	| Поворот фиксированной ноги относительно корпуса. |	Угол положения в градусах. |	От 0 до 180	| Ad)90\n

## Статусы выполнения
Статус | Описание
--|--
"OK" | Успешно
"BAD_REQUEST" | Недопустимая длина команды или инлентификатор
"UNSUPPORTED_REQUEST_TYPE" | Неподдерживаемый тип команды
"UNSUPPORTED_PROPERTY" | Неподдерживаемое изменяемой свойство
"UNSUPPORTED_ACTION" | Неподдерживаемое действие
"INVALID_PARAMETERS" | Недопустимые входные параметры
"SUBBOARD_WRONG_PACKET" | Получен повреждённый пакет при передаче между платами (Внутренняя ошибка)
"SUBBOARD_READ_TIMEOUT" | Отсутствие ответа при передаче между платами (Внутренняя ошибка)
"INVALID_LEG_POSITION" | Недопустимое положение ноги
"QUEUE_IS_FULL" | Очередь ожидающих действий полна
"POWER_IS_OFF" | Питание ног выключено 
"INVALID_STAGE" | Недопустимая стадия (Внутренняя ошибка)
"GENERIC_ERROR" | Общая ошибка выполнения
